<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"><meta name="description" content="Spring事务详解"><meta name="hexo-theme-A4" content="v1.8.9"><link rel="alternate icon" type="image/webp" href="/avatar.png"><title>mytianya | Dream’s never sold, Blood’s never cold</title><link rel="stylesheet" href="/css/highlight/style1.css"><link rel="stylesheet" href="/css/reset.css"><link rel="stylesheet" href="/css/markdown.css"><link rel="stylesheet" href="/css/fonts.css"><link rel="stylesheet" href="/css/ui.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/returnToTop.css"><link rel="stylesheet" href="/css/unicons.css"><link rel="stylesheet" href="/css/toc.css"><link rel="stylesheet" href="/css/returnToLastPage.css"><link rel="stylesheet" href="/css/lightgallery.min.css"><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="mytianya" type="application/atom+xml">
</head><style>body{background-image:url(/img/leaves-pattern.png)}.paper{background-image:url(/img/leaves-pattern.png)}</style><body><div class="left-toc-container"><nav id="toc" class="bs-docs-sidebar"></nav></div><div class="paper"><div class="shadow-drop-2-bottom paper-main"><div class="header"><div class="header-container"><img style="width:56px;height:auto" alt="^-^" cache-control="max-age=86400" class="header-img" src="/avatar.png" width="10%"><div class="header-content"><a class="logo" href="/">mytianya</a> <span class="description"></span></div></div><ul class="nav"><li><a href="/">首页</a></li><li><a href="/list/">文章</a></li><li><a href="/about/">关于</a></li><li><a href="/tags/">标签</a></li><li><a href="/categories/">分类</a></li></ul></div><div class="post-main"><div class="post-main-title">Spring事务详解</div><div class="post-md"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7-ACID"><span class="post-toc-text">事务特性(ACID)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3"><span class="post-toc-text">Spring事务管理接口</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PlatformTransactionManager%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="post-toc-text">PlatformTransactionManager核心方法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TransactionDefinition%E4%BA%8B%E5%8A%A1%E5%AE%9A%E4%B9%89"><span class="post-toc-text">TransactionDefinition事务定义</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="post-toc-text">事务的传播行为</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%94%AF%E6%8C%81%E5%A4%96%E5%B1%82%E4%BA%8B%E5%8A%A1%E6%83%85%E5%86%B5"><span class="post-toc-text">支持外层事务情况</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%8D%E6%94%AF%E6%8C%81%E5%A4%96%E5%B1%82%E4%BA%8B%E5%8A%A1%E6%83%85%E5%86%B5"><span class="post-toc-text">不支持外层事务情况</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%B6%E4%BB%96%E6%83%85%E5%86%B5"><span class="post-toc-text">其他情况</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="post-toc-text">事务的隔离级别</span></a></li></ol></li></ol><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Spring%E4%BA%8B%E5%8A%A1%E9%9B%86%E6%88%90"><span class="post-toc-text">Spring事务集成</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="post-toc-text">声明式事务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="post-toc-text">编程式事务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AOP%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1"><span class="post-toc-text">AOP全局事务</span></a></li></ol></li><div class=".article-gallery"><blockquote><p>事务是逻辑上的一组操作，要么都执行，要么都不执行。</p></blockquote><h2 id="事务特性-ACID"><a href="#事务特性-ACID" class="headerlink" title="事务特性(ACID)"></a>事务特性(ACID)</h2><ul><li>Atomicity（原子性）：一个事务（transaction）中的所有操作，或者全部完成，或者全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9B%9E%E6%BB%9A_(%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86)">回滚</a>（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。即，事务不可分割、不可约简。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ACID#cite_note-acid-1">1]</a></li><li>Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7">约束</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A7%A6%E5%8F%91%E5%99%A8_(%E6%95%B0%E6%8D%AE%E5%BA%93)">触发器</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BA%A7%E8%81%94%E5%9B%9E%E6%BB%9A">级联回滚</a>等。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ACID#cite_note-acid-1">1]</a></li><li>Isolation（隔离性）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括未提交读（Read uncommitted）、提交读（read committed）、可重复读（repeatable read）和串行化（Serializable）。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ACID#cite_note-acid-1">1]</a></li><li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li></ul><h2 id="Spring事务管理接口"><a href="#Spring事务管理接口" class="headerlink" title="Spring事务管理接口"></a>Spring事务管理接口</h2><p>​	<strong>Spring并不直接管理事务，而是提供了多种事务管理器</strong> ，他们将事务管理的职责委托给Hibernate或者JTA等持久化机制所提供的相关平台框架的事务来实现。 Spring事务管理器的接口是： <strong>org.springframework.transaction.PlatformTransactionManager</strong> ，通过这个接口，Spring为各个平台如JDBC、Hibernate等都提供了对应的事务管理器，但是具体的实现就是各个平台自己的事情了。</p><p><a href="/img/PlatformTransactionManager.png" title="PlatformTransactionManager" class="gallery-item" style="box-shadow:none"><img src="/img/PlatformTransactionManager.png" alt="PlatformTransactionManager"></a></p><h3 id="PlatformTransactionManager核心方法"><a href="#PlatformTransactionManager核心方法" class="headerlink" title="PlatformTransactionManager核心方法"></a>PlatformTransactionManager核心方法</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title class_">TransactionManager</span> {</span><br><span class="line">	<span class="comment">//根据指定的传播行为，返回当前活动的事务或创建一个新事务</span></span><br><span class="line">	TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span></span><br><span class="line">			<span class="keyword">throws</span> TransactionException;</span><br><span class="line">	<span class="comment">//使用事务目前的状态提交事务</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">	<span class="comment">//对执行的事务进行回滚</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="TransactionDefinition事务定义"><a href="#TransactionDefinition事务定义" class="headerlink" title="TransactionDefinition事务定义"></a>TransactionDefinition事务定义</h3><ul><li>事务的传播行为</li><li>事务隔离级别</li><li>事务名称</li><li>事务超时时间</li><li>是否为<a target="_blank" rel="noopener" href="https://blog.csdn.net/andyzhaojianhui/article/details/51984157">只读事务</a></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionDefinition</span> {</span><br><span class="line">    <span class="comment">// 返回事务的传播行为</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getPropagationBehavior</span><span class="params">()</span>; </span><br><span class="line">    <span class="comment">// 返回事务的隔离级别，事务管理器根据它来控制另外一个事务可以看到本事务内的哪些数据</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getIsolationLevel</span><span class="params">()</span>; </span><br><span class="line">    <span class="comment">// 返回事务必须在多少秒内完成</span></span><br><span class="line">    <span class="comment">//返回事务的名字</span></span><br><span class="line">    String <span class="title function_">getName</span><span class="params">()</span>；</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getTimeout</span><span class="params">()</span>;  </span><br><span class="line">    <span class="comment">// 返回是否优化为只读事务。</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isReadOnly</span><span class="params">()</span>;</span><br><span class="line">} </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="事务的传播行为"><a href="#事务的传播行为" class="headerlink" title="事务的传播行为"></a>事务的传播行为</h3><p>简单的来说，多个事务方法相互调用时,事务如何在这些方法间传播。</p><blockquote><p>举个栗子，方法A是一个事务的方法，方法A执行过程中调用了方法B，那么方法B有无事务以及方法B对事务的要求不同都会对方法A的事务具体执行造成影响，同时方法A的事务对方法B的事务执行也有影响，这种影响具体是什么就由两个方法所定义的事务传播类型所决定。</p></blockquote><h5 id="支持外层事务情况"><a href="#支持外层事务情况" class="headerlink" title="支持外层事务情况"></a>支持外层事务情况</h5><ul><li>Required: 当前外层存在事务，加入当前事务。没有自己创建新一个事务。</li><li>Supports: 当前外层存在事务，加入当前事务。没有自己以非事务方式运行。</li><li>Mandatory: 当前外层存在事务，加入当前事务。没有当前事务，抛出异常。</li></ul><h4 id="不支持外层事务情况"><a href="#不支持外层事务情况" class="headerlink" title="不支持外层事务情况"></a>不支持外层事务情况</h4><ul><li>Required_NEW: 创建一个新事务，当前外层存在事务，则挂起当前事务。</li><li>Not_Supported: 以非事务方式运行。当前外层存在事务，则挂起当前事务。</li><li>Never: 以非事务方式运行。当前外层存在事务，则抛出异常。</li></ul><h4 id="其他情况"><a href="#其他情况" class="headerlink" title="其他情况"></a>其他情况</h4><ul><li>Nested: 当前外层存在事务，则创建一个嵌套事务作为当前事务的嵌套事务来运行。没有等于Required。</li></ul><h4 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h4><p>定义了一个事务可能受其他并发事务影响的程度。</p><p><strong>TransactionDefinition.ISOLATION_DEFAULT:</strong>	使用后端数据库默认的隔离级别，Mysql 默认采用的 REPEATABLE_READ隔离级别 Oracle 默认采用的 READ_COMMITTED隔离级别.</p><p><strong>TransactionDefinition.ISOLATION_READ_UNCOMMITTED:</strong> 最低的隔离级别，允许读取尚未提交的数据变更，<strong>可能会导致脏读、幻读或不可重复读</strong></p><p><strong>TransactionDefinition.ISOLATION_READ_COMMITTED:</strong> 允许读取并发事务已经提交的数据，<strong>可以阻止脏读，但是幻读或不可重复读仍有可能发生</strong></p><p><strong>TransactionDefinition.ISOLATION_REPEATABLE_READ:</strong> 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，<strong>可以阻止脏读和不可重复读，但幻读仍有可能发生。</strong></p><p><strong>TransactionDefinition.ISOLATION_SERIALIZABLE:</strong> 最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，<strong>该级别可以防止脏读、不可重复读以及幻读</strong>。但是这将严重影响程序的性能。通常情况下也不会用到该级别。</p><h2 id="Spring事务集成"><a href="#Spring事务集成" class="headerlink" title="Spring事务集成"></a>Spring事务集成</h2><h3 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h3><p>通过在方法或类或接口上添加注解进行包装，无侵入地实现事务，更方便，但粒度更大。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED,timeout = 3000,rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">save</span><span class="params">(Integer id,String name)</span>{</span><br><span class="line">    String insertSql=<span class="string">"insert into `tb_user`(`id`,`name`)values(?,?);"</span>;</span><br><span class="line">    jdbcTemplate.update(insertSql,id,name);</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">"select  count(*) from tb_user"</span>,Integer.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h3><p>通过编码的方式手动启用、提交或回滚事务，粒度更细，但更麻烦。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">save</span><span class="params">(Integer id,String name)</span>{</span><br><span class="line">    Integer num=transactionTemplate.&lt;Integer&gt;execute((TransactionStatus status)-&gt;{</span><br><span class="line">      <span class="keyword">try</span>{</span><br><span class="line">        String insertSql=<span class="string">"insert into `tb_user`(`id`,`name`)values(?,?);"</span>;</span><br><span class="line">        jdbcTemplate.update(insertSql,id,name);</span><br><span class="line">      }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        status.setRollbackOnly();</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">"select  count(*) from tb_user"</span>,Integer.class);</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">  }</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">save2</span><span class="params">(Integer id,String name)</span>{</span><br><span class="line">    TransactionStatus transactionStatus=transactionManager.getTransaction(<span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>());</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">      String insertSql=<span class="string">"insert into `tb_user`(`id`,`name`)values(?,?);"</span>;</span><br><span class="line">      jdbcTemplate.update(insertSql,id,name);</span><br><span class="line">        transactionManager.commit(transactionStatus);</span><br><span class="line">      }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        transactionManager.rollback(transactionStatus);</span><br><span class="line">      }</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">"select  count(*) from tb_user"</span>,Integer.class);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><h3 id="AOP全局事务"><a href="#AOP全局事务" class="headerlink" title="AOP全局事务"></a>AOP全局事务</h3><p>一般在项目中使用等待全局性事务，拦截特定包下面的特定方法，不推荐使用。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//事务依然生效</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(DataSource.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TxAdviceInterceptor</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line">  <span class="meta">@Value("${tx.timeout:5}")</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">TX_METHOD_TIMEOUT</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">AOP_POINTCUT_EXPRESSION</span> <span class="operator">=</span> <span class="string">"execution(* codehome.vip.*.service.*.*(..)) "</span>;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> TransactionInterceptor <span class="title function_">txAdvice</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">NameMatchTransactionAttributeSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NameMatchTransactionAttributeSource</span>();</span><br><span class="line">    <span class="comment">/*只读事务，不做更新操作*/</span></span><br><span class="line">    <span class="type">RuleBasedTransactionAttribute</span> <span class="variable">readOnlyTx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleBasedTransactionAttribute</span>();</span><br><span class="line">    readOnlyTx.setReadOnly(<span class="literal">true</span>);</span><br><span class="line">    readOnlyTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_NOT_SUPPORTED);</span><br><span class="line">    <span class="comment">/*当前存在事务就使用当前事务，当前不存在事务就创建一个新的事务*/</span></span><br><span class="line">    <span class="type">RuleBasedTransactionAttribute</span> <span class="variable">requiredTx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleBasedTransactionAttribute</span>();</span><br><span class="line">    requiredTx.setRollbackRules(</span><br><span class="line">        Collections.singletonList(<span class="keyword">new</span> <span class="title class_">RollbackRuleAttribute</span>(Exception.class)));</span><br><span class="line">    requiredTx.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line">    requiredTx.setTimeout(TX_METHOD_TIMEOUT);</span><br><span class="line">    Map&lt;String, TransactionAttribute&gt; txMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    txMap.put(<span class="string">"save*"</span>, requiredTx);</span><br><span class="line">    txMap.put(<span class="string">"update*"</span>, requiredTx);</span><br><span class="line">    txMap.put(<span class="string">"remove*"</span>, requiredTx);</span><br><span class="line">    txMap.put(<span class="string">"*"</span>, readOnlyTx);</span><br><span class="line">    source.setNameMap(txMap);</span><br><span class="line">    <span class="type">TransactionInterceptor</span> <span class="variable">txAdvice</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionInterceptor</span>(transactionManager, source);</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br><span class="line">      logger.info(<span class="string">"事务管理器启动成功！"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> txAdvice;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> Advisor <span class="title function_">txAdviceAdvisor</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">AspectJExpressionPointcut</span> <span class="variable">pointcut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AspectJExpressionPointcut</span>();</span><br><span class="line">    pointcut.setExpression(AOP_POINTCUT_EXPRESSION);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultPointcutAdvisor</span>(pointcut, txAdvice());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div><script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery){var options={selector:".gallery-item"};lightGallery(document.getElementsByClassName(".article-gallery")[0],options)}</script></div><div class="post-meta"><i><span>2023-09-25</span> <span>该篇文章被 mytianya</span> <span>打上标签: <a href="/tags/springboot/">springboot </a></span><span>归为分类: <a href="/categories/java/">java</a></span></i></div><br></div><div class="footer"><span>© 1949-2024 China</span></div><div class="footer-last"><span>🌊Dream’s never sold, Blood’s never cold🌊</span> <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript"></script><script src="/js/toc.js"></script><script src="/js/randomHeaderContent.js"></script><script src="/js/returnToTop.js"></script><script src="/js/returnToLastPage.js"></script><script src="/js/lightgallery.min.js"></script></div><div class="progress-wrap shadow-drop-2-bottom"><svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102"><path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/></svg></div><div class="return-to-last-progress-wrap shadow-drop-2-bottom"><svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102"><path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/></svg></div></div></body><script src="/js/darkmode-js.min.js"></script><script>function addDarkmodeWidget(){new Darkmode({bottom:"53px",right:"unset",left:"42px",time:"0.3s",mixColor:"#fff",backgroundColor:" #e4e4e4 ",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌓",autoMatchOsTheme:!0}).showWidget()}window.addEventListener("load",addDarkmodeWidget)</script></html>